---
title: "EJ01"
output: html_document
date: "`r Sys.Date()`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Primero, carguemos los datos.

```{r}
src_dir <- "~/Downloads"
src_basename <- "EP08 Datos CASEN 2017.csv"
src_file <- file.path(src_dir, src_basename)
datos <- read.csv2(file = src_file, stringsAsFactors = TRUE, fileEncoding = "ISO-8859-1")
```

Filtremos para obtener los datos de interÃ©s y obtengamos la muestra que se solicita.

```{r}
library(dplyr)

set.seed(347)
n1 <- 125
muestra1 <- datos %>% filter(region != "RegiÃ³n Metropolitana de Santiago") %>%
  filter(h10e %in% c("No puede hacerlo", "SÃ­, mucha dificultad")) %>%
  filter(!is.na(o29)) %>%
  mutate(cotiza = ifelse(o29 == "No estÃ¡ cotizando", "No", "SÃ­")) %>%
  select(sexo, cotiza) %>%
  sample_n(n1)
```


Definamos una funciÃ³n que calcule la diferencia entre las proporciones de hombres y mujeres que cotizan para su jubilaciÃ³n.

```{r}
get.prop.dif <- function(df, verbose = FALSE)
{
  tabla <- table(df)
  if(verbose)
    print(tabla)
  ph <- tabla[1, 2] / (tabla[1, 1] + tabla[1, 2])
  pm <- tabla[2, 2] / (tabla[2, 1] + tabla[2, 2])
  if(verbose)
  {
    cat("\n")
    cat("ProporciÃ³n de personas que cotizan:\n")
    cat("Hombres:", round(ph, 4), "\n")
    cat("Mujeres:", round(pm, 4), "\n")
  }
  return(ph - pm)
}
```

Calculemos, usando esta funciÃ³n, la diferencia observada en la muestra obtenida.


```{r}
dif.obs <- get.prop.dif(muestra1, TRUE)
cat("\nDiferencia de proporciones observada:", round(dif.obs, 3), "\n")
```

Vemos que la diferencia en las muestras es bastante pequeÃ±a: 0,7%

.
Formulemos las hipÃ³tesis:

H0: Las proporciones de hombres (ğ‘â„) y mujeres (ğ‘ğ‘š) que viven en la RegiÃ³n Metropolitana de Santiago y que declaran tener problemas serios de movilidad pero que estÃ¡n cotizando para su jubilaciÃ³n son iguales: ğ‘â„âˆ’ğ‘ğ‘š=0

Hğ´: Por el contrario, estas proporciones son distintas: ğ‘â„âˆ’ğ‘ğ‘šâ‰ 0. 

Definamos el nÃºmero de permutaciones que vamos a trabajar (y si queremos mensajes).

```{r}
R <- 2999
verbose <- FALSE
if(R < 10)
  verbose <- TRUE
```

Obtenemos las permutaciones, teniendo cuidado de usar una semilla, como indica el enunciado, que nos poermita obtener los mismos resultados cada que vez que ejecutemos el script.

```{r}
set.seed(349)
permutaciones <- lapply(1:R, function(i) sample(1:n1))
```

Obtenemos la distribuciÃ³n permutada de las diferencias de proporciones aplicando la funciÃ³n get.prop.dif() a cada una de las permutaciones generadas. Notemos que solo necesitamos permutar la variable â€œsexoâ€, que es la que define en quÃ© grupo estÃ¡ incluido cada caso.

```{r}
get.prop.dif.perm <- function(indices, df, verbose = FALSE)
{
  df.nuevo <- data.frame(sexo = df[indices, "sexo"], df[["cotiza"]])
  get.prop.dif(df.nuevo, verbose)
}
distribucion <- sapply(permutaciones, get.prop.dif.perm, muestra1, verbose)
```

Revisemos cÃ³mo se ve esta distribuciÃ³n respecto del valor observado en la muestra original.

```{r}
library(ggpubr)

p1 <- gghistogram(data.frame(distribucion), "distribucion", bins = 30, fill = "blue",
                  title = "DistribuciÃ³n permutada",
                  xlab = "Diferencia entre las proporciones de hombres y mujeres",
                  ylab = "Frecuencia")
p1 <- p1 + geom_vline(xintercept = dif.obs, colour="red")
print(p1)
```

Podemos ver que la diferencia de las proporciones observada en la muestra original se ubica cerca del centro de distribuciÃ³n, no muy lejos del valor cero.

Calculemos el intervalo de 95% confianza y el valor p para una prueba bilateral (usando el valor absoluto de las diferencias) con 95% de confianza, es decir la probabilidad de encontrar diferencias al menos tan extremas como la diferencia observada.

```{r}
ci1 <- quantile(distribucion, c(0.025, 0.975))
numerador1 <- sum(abs( distribucion) > abs(dif.obs))
valor_p1 <- (numerador1 + 1) / (R + 1)

cat("IC 95%: [", round(ci1[1], 3), ", ", round(ci1[2], 3), "]\n", sep = "")
cat("P-valor:", round(valor_p1, 3))
```

Lo que nos lleva a la siguiente conclusiÃ³n:

Se puede concluir, con 95% confianza, que no hay evidencia suficiente para rechazar la hipÃ³tesis nula (ğ‘=0,851
) y tenemos que concluir que no es posible descartar que las proporciones de hombres y mujeres con problemas serios de movilidad que estÃ¡n cotizando para su jubilaciÃ³n son iguales (IC 95%=[âˆ’0,16,0,18]).


# Pregunta 2

En este caso, consideraremos la pregunta: Â¿es igual el ingreso per cÃ¡pita en las regiones de Atacama, Coquimbo y del Maule?

Esta pregunta requiere contrastar las medias de 3 grupos independientes. Al haber mÃ¡s de dos medias, no es posible comparar directamente sus diferencias. AsÃ­, lo mÃ¡s conveniente en este caso es utilizar el estadÃ­stico F para evaluar su igualdad.

Filtremos los datos y obtengamos la muestra como se solicita.

```{r}
n2 <- 275
set.seed(572)
regiones <- c("RegiÃ³n de Coquimbo", "RegiÃ³n de Atacama", "RegiÃ³n del Maule")
muestra2 <- datos %>% filter(region %in% regiones) %>% droplevels() %>%
  mutate(region = recode(region, "RegiÃ³n de Atacama" = "Atacama")) %>%
  mutate(region = recode(region, "RegiÃ³n de Coquimbo" = "Coquimbo")) %>%
  mutate(region = recode(region, "RegiÃ³n del Maule" = "Maule")) %>%
  select(ytotcorh, numper, region) %>%
  mutate(ypercap = ytotcorh/numper, .keep = "unused") %>%
  sample_n(n2)
```

Formulamos las hipÃ³tesis:

H0: El ingreso per cÃ¡pita promedio es igual en las regiones de Atacama (ğœ‡ğ´), Coquimbo (ğœ‡ğ¶) y el Maule (ğœ‡ğ‘€): ğœ‡ğ´=ğœ‡ğ¶=ğœ‡ğ‘€.

Ha: El ingreso per cÃ¡pita promedio es distinto en las regiones de Atacama, Coquimbo y el Maule: âˆƒ(ğ‘,ğ‘)âˆˆ{ğ´,ğ¶,ğ‘€}âˆ£ğœ‡ğ‘â‰ ğœ‡ğ‘


Revisemos el tamaÃ±o de las muestras de observaciones en cada grupo.

```{r}
print(summary(muestra2[["region"]]))
```

Ooops! Una complicaciÃ³n extra, puesto que las muestras tienen tamaÃ±os distintos y debemos mantener esos tamaÃ±os en el remuestreo. Separamos los Ã­ndices de cada regiÃ³n con este objetivo en mente.

```{r}
iAtacama <- which(muestra2[["region"]] == "Atacama")
iCoquimbo <- which(muestra2[["region"]] == "Coquimbo")
iMaule <- which(muestra2[["region"]] == "Maule")
```

Revisemos los datos.

```{r}
muestra2[["ypercap_miles"]] <- muestra2[["ypercap"]] / 1000
p2 <- ggboxplot(muestra2, x = "region", y = "ypercap_miles", fill = "region")
p2 <- p2 + xlab("RegiÃ³n") + ylab("Ingreso per cÃ¡pita (miles de pesos)")
print(p2)
```

Podemos ver que los datos, ademÃ¡s de estar desbalanceados, parecen no cumplir con la condiciÃ³n de heterocedasticidad y presentan numerosos valores atÃ­picos. AsÃ­, no podemos usar un mÃ©todo de anÃ¡lisis clÃ¡sico y debemos recurrir a mÃ©todos apropiados, en este caso remuestreo con bootstrapping.

Definimos una funciÃ³n que calcula el estadÃ­stico de interÃ©s que, como se dijo, corresponde al estadÃ­stico F usado por ANOVA para muestras independientes.

```{r}
library(ez)

get.F <- function(df, iA, iC, iM, verbose = FALSE)
{
  # Armamos la matriz de datos con los Ã­ndices recibidos 
  i <- c(iA, iC, iM)
  ids <- factor(1:length(i))
  datos <- cbind(id = ids, df[i, ])
  dd <<- datos
  
  ez <- ezANOVA(datos, ypercap, id, between = region, type = 2)
  if(verbose)
    print(ez)
  return(ez[["ANOVA"]][["F"]])
}
```

Obtenemos el estadÃ­stico para la muestra original.

```{r}
F.obs <- get.F(muestra2, iAtacama, iCoquimbo, iMaule, TRUE)
```

Notemos que la llamada a ezANOVA()genera un mensaje (inÃºtil y molesto a estas alturas) y una advertencia relacionada al desbalance en los datos. Como se comentÃ³ en el apunte, especificando type = 2 resuelve este inconveniente en la mayorÃ­a de los casos.

Debemos recordar que, a diferencia del caso anterior con permutaciones, con bootstrapping (al remuestrear con reemplazo la muestra original) las remuestras no representan la hipÃ³tesis nula. Cuando tenÃ­amos dos muestras, podÃ­amos recentrar la distribuciÃ³n bootstrap en el valor nulo. Pero Â¿cÃ³mo hacemos esto con el estadÃ­stico F?

Para ello debemos considerar que si la hipÃ³tesis nula se cumple, los tres grupos tienen las mismas medias y varianzas. Con mÃ¡s de dos grupos, es mÃ¡s fÃ¡cil hacer estos ajustes antes del remuestreo. Para ello, nos basamos en las ideas propuestas por Fisher & Hall (1990), Hall & Wilson (1991) y Martin (2007).

Primero vamos a obtener las medidas generales (pooled).

```{r}
media.gral <- mean(muestra2[["ypercap"]])
sd.gral <- sd(muestra2[["ypercap"]])
```

Luego obtenemos las medidas por grupo (por regiÃ³n en este caso):

```{r}
grupos <- muestra2 %>%
  group_by(region) %>%
  summarise(media = mean(ypercap), sd = sd(ypercap)) %>%
  as.data.frame()
```

Ahora desplazamos los valores vistos para que los tres grupos tengan la misma media e igual varianza (en rigor, desviaciÃ³n estÃ¡ndar).

```{r}
muestra2b <- muestra2
muestra2b[iAtacama, "ypercap"] <- media.gral +
  (muestra2b[iAtacama, "ypercap"] - grupos[1, "media"]) *
  (sd.gral / grupos[1, "sd"])
muestra2b[iCoquimbo, "ypercap"] <- media.gral +
  (muestra2b[iCoquimbo, "ypercap"] - grupos[2, "media"]) *
  (sd.gral / grupos[2, "sd"])
muestra2b[iMaule, "ypercap"] <- media.gral +
  (muestra2b[iMaule, "ypercap"] - grupos[3, "media"]) *
  (sd.gral / grupos[3, "sd"])
```

Definamos el nÃºmero de remuestreos que vamos a utilizar (y si queremos mensajes a pantalla).

```{r}
B <- 2999
verbose <- FALSE
if(B < 10)
  verbose <- TRUE
```

Generamos las remuestras definiendo una semilla adecuada y muestreando con reemplazo los Ã­ndices de los datos de cada grupo.

```{r}
set.seed(573)
re.iAtacama <- lapply(1:B, function(i) sample(iAtacama, replace = TRUE))
re.iCoquimbo <- lapply(1:B, function(i) sample(iCoquimbo, replace = TRUE))
re.iMaule <- lapply(1:B, function(i) sample(iMaule, replace = TRUE))
```

Obtenemos la distribuciÃ³n bootstrapping remuestreando cada regiÃ³n por separado (evitando mensajes y advertencias)

```{r}
cat("Remuestreando, por favor espere...\n")
get.F.boot <- function(i, df, verbose = FALSE)
  get.F(df, re.iAtacama[[i]], re.iCoquimbo[[i]], re.iMaule[[i]], verbose)

distribucion <- suppressMessages(suppressWarnings(
  sapply(1:B, function(i) get.F.boot(i, muestra2b, verbose))
))
```

Revisemos cÃ³mo se ve esta distribuciÃ³n respecto del valor observado en la muestra original.

```{r}
p2 <- gghistogram(data.frame(distribucion), x = "distribucion",
                  title = "DistribuciÃ³n permutada",
                  xlab = "EstadÃ­stico F", ylab = "Frecuencia",
                  bins = 30, fill = "blue")
p2 <- p2 + geom_vline(xintercept = F.obs, colour="red")
print(p2)
```

Vemos que el valor F observado parece estar bastante alejado de lo esperado si la hipÃ³tesis nula fuera cierta. Calculemos el valor crÃ­tico de F con 95% confianza en esta distribuciÃ³n empÃ­rica y estimemos el valor p correspondiente para el valor F observado.

```{r}
F_crit <- quantile(distribucion, 0.95)
cat("F crÃ­tico con 95% de confianza:", round(F_crit, 3), "\n")

numerador2 <- sum(distribucion > F.obs)
valor_p2 <- (numerador2 + 1) / (B + 1)
cat("P-valor:", round(valor_p2, 3))
```

Estamos en condiciones de concluir respecto a la prueba Ã³mnibus:

Observamos que si la hipÃ³tesis nula es correcta, el estadÃ­stico ğ¹(2,272)
no debiera ser superior a 3,08 con 95% confianza. Como el estadÃ­stico F observado (en la muestra original) fue ğ¹(2,272)=4,56, que tiene una baja probabilidad de ser encontrado (ğ‘=0,015), se rechaza la hipÃ³tesis nula en favor de la alternativa. Concluimos entonces, con 95% confianza, que el ingreso per cÃ¡pita promedio no es igual en las regiones estudiadas. Corresponde, entonces, hacer un anÃ¡lisis post-hoc.

Por conveniencia haremos comparaciones entre pares de regiones, teniendo cuidado de utilizar las mismas remuestras que usamos en la prueba Ã³mnibus. Al analizar pares de regiones, podemos usar la diferencia de las medias como estadÃ­stico de interÃ©s.

Escribamos la tÃ­pica funciÃ³n que calcula esta diferencia.

```{r}
get.dif.medias <- function(df, i1, i2)
{
  media1 <- mean(df[i1, "ypercap"]) 
  media2 <- mean(df[i2, "ypercap"])
  return(media1 - media2)
}
```

Obtenemos las diferencias observadas entre cada par de regiones.

```{r}
dif.obs.A.C <- get.dif.medias(muestra2, iAtacama, iCoquimbo)
dif.obs.A.M <- get.dif.medias(muestra2, iAtacama, iMaule)
dif.obs.C.M <- get.dif.medias(muestra2, iCoquimbo, iMaule)

cat("Atacama - Coquimbo:", round(dif.obs.A.C), "\n")
cat("Atacama - Maule:", round(dif.obs.A.M), "\n")
cat("Coquimbo - Maule:", round(dif.obs.C.M), "\n")
```



Obtenemos las distribuciones bootstrap para cada diferencia.


```{r}
dist.boot.dif.A.C <- sapply(1:B,
                            function(i) get.dif.medias(muestra2b,
                                                       re.iAtacama[[i]],
                                                       re.iCoquimbo[[i]]))
dist.boot.dif.A.M <- sapply(1:B,
                            function(i) get.dif.medias(muestra2b,
                                                       re.iAtacama[[i]],
                                                       re.iMaule[[i]]))
dist.boot.dif.C.M <- sapply(1:B,
                            function(i) get.dif.medias(muestra2b,
                                                       re.iCoquimbo[[i]],
                                                       re.iMaule[[i]]))
```

Y las graficamos (en miles de pesos).

```{r}
p3a <- gghistogram(data.frame(Diferencia = dist.boot.dif.A.C / 1000), x = "Diferencia",
                   title = "Atacama-Coquimbo",
                   xlab = "Diferencia (miles de pesos)", ylab = "Frecuencia",
                   bins = 30, fill = "blue")
p3a <- p3a + geom_vline(xintercept = dif.obs.A.C / 1000, colour="red")
p3b <- gghistogram(data.frame(Diferencia = dist.boot.dif.A.M / 1000), x = "Diferencia",
                   title = "Atacama-Maule",
                   xlab = "Diferencia (miles de pesos)", ylab = "Frecuencia",
                   bins = 30, fill = "blue")
p3b <- p3b + geom_vline(xintercept = dif.obs.A.M / 1000, colour="red")
p3c <- gghistogram(data.frame(Diferencia = dist.boot.dif.C.M / 1000), x = "Diferencia",
                   title = "Coquimbo-Maule",
                   xlab = "Diferencia (miles de pesos)", ylab = "Frecuencia",
                   bins = 30, fill = "blue")
p3c <- p3c + geom_vline(xintercept = dif.obs.C.M / 1000, colour="red")
p3 <- ggarrange(p2, p3a, p3b, p3c, nrow = 2, ncol = 2)
print(p3)
```

En los grÃ¡ficos queda bastante claro dÃ³nde estÃ¡n las diferencias, pero para seguir con el ejercicio, calculamos los p-valores de pruebas bilaterales (usando el valor absoluto de las diferencias) y ajustados por pruebas mÃºltiples.

```{r}
valor_p.A.C <- (sum(abs(dist.boot.dif.A.C) > abs(dif.obs.A.C)) + 1) / (B + 1)
valor_p.A.M <- (sum(abs(dist.boot.dif.A.M) > abs(dif.obs.A.M)) + 1) / (B + 1)
valor_p.C.M <- (sum(abs(dist.boot.dif.C.M) > abs(dif.obs.C.M)) + 1) / (B + 1)
valores_p.adj <- p.adjust(c(valor_p.A.C, valor_p.A.M, valor_p.C.M), method = "BH")

cat("Valores p de pruebas bilaterales:\n")
cat("Atacama - Coquimbo:", round(valores_p.adj[1], 3), "\n")
cat("Atacama - Maule   :", round(valores_p.adj[2],3), "\n")
cat("Coquimbo - Maule  :", round(valores_p.adj[3], 3), "\n")
```



TambiÃ©n podemos usar las remuestras para estimar los intervalos de confianza de las diferencias de las medias de ingresos per cÃ¡pita entre las regiones observadas en en estudio.

```{r}
dist.boot.dif.obs.A.C <- sapply(1:B,
                                function(i) get.dif.medias(muestra2,
                                                          re.iAtacama[[i]],
                                                          re.iCoquimbo[[i]]))
dist.boot.dif.obs.A.M <- sapply(1:B,
                                function(i) get.dif.medias(muestra2,
                                                          re.iAtacama[[i]],
                                                          re.iMaule[[i]]))
dist.boot.dif.obs.C.M <- sapply(1:B,
                                function(i) get.dif.medias(muestra2,
                                                          re.iCoquimbo[[i]],
                                                          re.iMaule[[i]]))

ci.dif.obs.A.C <- quantile(dist.boot.dif.obs.A.C, c(0.025, 0.975))
ci.dif.obs.A.M <- quantile(dist.boot.dif.obs.A.M, c(0.025, 0.975))
ci.dif.obs.C.M <- quantile(dist.boot.dif.obs.C.M, c(0.025, 0.975))

cat("Intervalos de 95% confianza:\n")
cat("Atacama - Coquimbo: [", round(ci.dif.obs.A.C[1], 3), ", ",
                             round(ci.dif.obs.A.C[2], 3), "]\n", sep = "")
cat("Atacama - Maule   : [", round(ci.dif.obs.A.M[1], 3), ", ",
                             round(ci.dif.obs.A.M[2], 3), "]\n", sep = "")
cat("Coquimbo - Maule  : [", round(ci.dif.obs.C.M[1], 3), ", ",
                             round(ci.dif.obs.C.M[2], 3), "]\n", sep = "")
```

AsÃ­, llegamos a la siguiente conclusiÃ³n.

En base al procedimiento post-hoc, podemos concluir con 95% de confianza que no hay diferencias significativas en el ingreso per cÃ¡pita promedio de las regiones de Coquimbo y del Maule (IC 95%=[âˆ’$61.347,$68.950],ğ‘=0,885
), pero que estos son significativamente menores al ingreso per cÃ¡pita promedio de la regiÃ³n de Atacama (Coquimbo: IC 95%=[$26.630,$242.874],ğ‘=0,020; Maule: IC 95%=[$29.800,$248.523],ğ‘=0,020).
